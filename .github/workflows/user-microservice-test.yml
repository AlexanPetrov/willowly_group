name: User Microservice Test

on:
  push:
    branches: [ main ]
    paths:
      - 'user-microservice/**'
      - '.github/workflows/user-microservice-test.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'user-microservice/**'
      - '.github/workflows/user-microservice-test.yml'

defaults:
  run:
    working-directory: user-microservice

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
    
    - name: Create .env.test file
      run: |
        cat > .env.test << 'EOF'
        APP_NAME=User Microservice
        APP_ENV=test
        DB_URL=postgresql+asyncpg://api_user:pass123@localhost:5432/user_microservice_db
        JWT_SECRET_KEY=test-secret-key-minimum-32-characters-long-for-testing
        JWT_ALGORITHM=HS256
        JWT_EXPIRATION_MINUTES=30
        REDIS_URL=redis://localhost:6379/1
        CACHE_TTL=300
        CACHE_ENABLED=true
        ENABLE_METRICS=true
        LOG_LEVEL=INFO
        EOF
    
    - name: Start services
      working-directory: user-microservice
      run: |
        docker compose up -d db redis
        sleep 5
    
    - name: Wait for PostgreSQL
      working-directory: user-microservice
      run: |
        until docker compose exec -T db pg_isready -U api_user -d user_microservice_db; do
          echo "Waiting for PostgreSQL..."
          sleep 2
        done
    
    - name: Wait for Redis
      working-directory: user-microservice
      run: |
        until docker compose exec -T redis redis-cli ping; do
          echo "Waiting for Redis..."
          sleep 2
        done
    
    - name: Install dependencies
      run: uv sync
    
    - name: Run migrations
      run: uv run alembic upgrade head
      env:
        APP_ENV: test
        DB_URL: postgresql+asyncpg://api_user:pass123@localhost:5432/user_microservice_db
        JWT_SECRET_KEY: test-secret-key-minimum-32-characters-long-for-testing
    
    - name: Run tests
      run: uv run pytest -v --tb=short
      env:
        APP_ENV: test
        DB_URL: postgresql+asyncpg://api_user:pass123@localhost:5432/user_microservice_db
        REDIS_URL: redis://localhost:6379/1
        JWT_SECRET_KEY: test-secret-key-minimum-32-characters-long-for-testing
        ENABLE_METRICS: "true"
    
    - name: Stop services
      working-directory: user-microservice
      if: always()
      run: docker compose down -v
